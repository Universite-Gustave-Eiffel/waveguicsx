<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorials &mdash; waveguicsx 2.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="waveguicsx.waveguide" href="waveguicsx.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html">
            <img src="_static/logo_doc.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme_link.html">Presentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="readme_link.html#introduction">0. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="readme_link.html#basic-examples">1. Basic examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="readme_link.html#prerequisites">2. Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="readme_link.html#installation">3. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="readme_link.html#documentation">4. Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="readme_link.html#tutorials">5. Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="readme_link.html#scattering-by-local-inhomogeneities">6. Scattering by local inhomogeneities</a></li>
<li class="toctree-l2"><a class="reference internal" href="readme_link.html#authors-and-contributors">7. Authors and contributors</a></li>
<li class="toctree-l2"><a class="reference internal" href="readme_link.html#how-to-cite">8. How to cite</a></li>
<li class="toctree-l2"><a class="reference internal" href="readme_link.html#license">9. License</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html">Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="waveguicsx.html">waveguicsx.waveguide</a></li>
<li class="toctree-l2"><a class="reference internal" href="waveguicsx.html#waveguicsx-scattering">waveguicsx.scattering</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#three-dimensional-elastic-bar-of-square-cross-section">0. Three-dimensional elastic bar of square cross-section</a></li>
<li class="toctree-l2"><a class="reference internal" href="#three-dimensional-elastic-bar-of-square-cross-section-with-parallelization">1. Three-dimensional elastic bar of square cross-section with parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#three-dimensional-elastic-bar-of-square-cross-section-buried-into-a-pml-external-medium">2. Three-dimensional elastic bar of square cross-section buried into a PML external medium</a></li>
<li class="toctree-l2"><a class="reference internal" href="#three-dimensional-elastic-bar-of-square-cross-section-buried-into-a-pml-external-medium-using-gmsh">3. Three-dimensional elastic bar of square cross-section buried into a PML external medium using gmsh</a></li>
<li class="toctree-l2"><a class="reference internal" href="#excitation-of-a-three-dimensional-elastic-bar-of-circular-cross-section">4. Excitation of a three-dimensional elastic bar of circular cross-section</a></li>
<li class="toctree-l2"><a class="reference internal" href="#excitation-of-a-three-dimensional-elastic-bar-of-circular-cross-section-with-parallelization">5. Excitation of a three-dimensional elastic bar of circular cross-section with parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#time-response-of-a-two-dimensional-plate-excited-near-its-first-zgv-resonance">6. Time response of a two-dimensional plate excited near its first ZGV resonance</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dispersion-curves-of-a-rail">7. Dispersion curves of a rail</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reflection-of-lamb-modes-by-the-free-edge-of-a-plate">8. Reflection of Lamb modes by the free edge of a plate</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reflection-and-transmission-of-pochhammer-chree-modes-inside-a-cylinder">9. Reflection and transmission of Pochhammer-Chree modes inside a cylinder</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">waveguicsx</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Tutorials</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorials.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorials">
<h1>Tutorials<a class="headerlink" href="#tutorials" title="Permalink to this heading"></a></h1>
<section id="three-dimensional-elastic-bar-of-square-cross-section">
<h2>0. Three-dimensional elastic bar of square cross-section<a class="headerlink" href="#three-dimensional-elastic-bar-of-square-cross-section" title="Permalink to this heading"></a></h2>
<p>3D (visco-)elastic waveguide example.
The cross-section is a 2D square with free boundary conditions on its boundaries.
Material: viscoelastic steel.
The SAFE eigenproblem is solved with the varying parameter as the wavenumber (eigenvalues are then frequencies) or as the frequency (eigenvalues are then wavenumbers).
Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities.
Results are compared with Euler-Bernoulli analytical solutions for the lowest wavenumber or frequency parameter.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023-2024  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D (visco-)elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D square with free boundary conditions on its boundaries\</span>
<span class="c1"># Material: viscoelastic steel\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># This eigenproblem is solved with the varying parameter as the wavenumber (eigenvalues are then frequencies) or as the frequency (eigenvalues are then wavenumbers)\</span>
<span class="c1"># Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities\</span>
<span class="c1"># Results are compared with Euler-Bernoulli analytical solutions for the lowest wavenumber or frequency parameter</span>

<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a jupyter notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;static&quot;); pyvista.start_xvfb() #try: &quot;none&quot;, &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#square half-length (m)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#number of finite elements along one half-side</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="mi">7932</span><span class="p">,</span> <span class="mi">3260</span><span class="p">,</span> <span class="mi">5960</span> <span class="c1">#core density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mf">0.008</span><span class="p">,</span> <span class="mf">0.003</span> <span class="c1">#core shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">500e3</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="mf">500e3</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c1">#angular frequency range (rad/s)</span>
<span class="n">wavenumber</span> <span class="o">=</span> <span class="n">omega</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#wavenumber range (1/m, eigenvalues are frequency)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#number of eigenvalues</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">wavenumber</span> <span class="o">=</span> <span class="n">wavenumber</span><span class="o">*</span><span class="n">L0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh and finite elements (six-node triangles with three dofs per node for the three components of displacement)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_rectangle</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">])],</span> 
                               <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">],</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">triangle</span><span class="p">)</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">))</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions (or uncomment lines below for Dirichlet)</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Dirichlet test case:</span>
<span class="c1">#fdim = mesh.topology.dim - 1</span>
<span class="c1">#boundary_facets = dolfinx.mesh.locate_entities_boundary(mesh, dim=fdim, marker=lambda x: np.logical_or(np.isclose(x[0], -a),</span>
<span class="c1">#                                                                                                       np.isclose(x[0], +a)+</span>
<span class="c1">#                                                                                                       np.isclose(x[1], -a)+</span>
<span class="c1">#                                                                                                       np.isclose(x[1], +a)))</span>
<span class="c1">#boundary_dofs = dolfinx.fem.locate_dofs_topological(V=V, entity_dim=fdim, entities=boundary_facets)</span>
<span class="c1">#bcs = [dolfinx.fem.dirichletbc(value=np.zeros(3, dtype=PETSc.ScalarType), dofs=boundary_dofs, V=V)]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">k0</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k0_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k0_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is k, the eigenvalue is omega**2</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">wavenumber</span><span class="o">=</span><span class="n">wavenumber</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span> <span class="c1">#access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Comparison with Euler-Bernoulli analytical solutions</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Computed eigenvalues for the first wavenumber (k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">):</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">E</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span> <span class="mf">0.1406</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#0.1406 is for square section</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Euler-Bernoulli beam solution (only accurate for low frequency):</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Bending wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="o">*</span><span class="n">I</span><span class="o">/</span><span class="n">rho</span><span class="o">/</span><span class="n">S</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">4</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Torsional wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">Ip</span><span class="o">/</span><span class="n">rho</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Longitudinal wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="n">rho</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is omega, the eigenvalue is k</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span> <span class="c1">#access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1">#blocking</span>

<span class="c1">##################################</span>
<span class="c1"># Comparison with Euler-Bernoulli analytical solutions</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Computed eigenvalues for the first frequency (omega=</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">):</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Euler-Bernoulli beam solution (only accurate for low frequency):</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Bending wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho</span><span class="o">*</span><span class="n">S</span><span class="o">/</span><span class="n">E</span><span class="o">/</span><span class="n">I</span><span class="o">*</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Torsional wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">I</span><span class="o">/</span><span class="n">mu</span><span class="o">/</span><span class="n">Ip</span><span class="o">*</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Longitudinal wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho</span><span class="o">/</span><span class="n">E</span><span class="o">*</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Mesh visualization</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Mode shape visualization</span>
<span class="n">ik</span><span class="p">,</span> <span class="n">imode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span> <span class="c1">#parameter index, mode index to visualize</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">getColumnVector</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span>
<span class="n">u_grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">))</span> <span class="c1">#V.element.value_shape is equal to 3</span>
<span class="n">u_plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">u_grid</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#do not show edges of higher order elements with pyvista</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="s2">&quot;&quot;</span>

</pre></div>
</div>
</section>
<section id="three-dimensional-elastic-bar-of-square-cross-section-with-parallelization">
<h2>1. Three-dimensional elastic bar of square cross-section with parallelization<a class="headerlink" href="#three-dimensional-elastic-bar-of-square-cross-section-with-parallelization" title="Permalink to this heading"></a></h2>
<p>3D (visco-)elastic waveguide example.
The cross-section is a 2D square with free boundary conditions on its 1D boundaries.
Material: viscoelastic steel.
Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities.
In this example:</p>
<ul class="simple">
<li><p>the parameter loop (here, the frequency loop) is distributed on all processes</p></li>
<li><p>FE mesh and matrices are built on each local process</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023-2024  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D (visco-)elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D square with free boundary conditions on its 1D boundaries\</span>
<span class="c1"># Material: viscoelastic steel\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities\</span>
<span class="c1"># In this example:</span>
<span class="c1"># - the parameter loop (here, the frequency loop) is distributed on all processes</span>
<span class="c1"># - FE mesh and matrices are built on each local process</span>
<span class="c1"># Reminder for an execution in parallel mode (e.g. 4 processes):</span>
<span class="c1">#  mpiexec -n 4 python3 Elastic_Waveguide_SquareBar3D_ParallelizedLoop.py</span>

<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1">#import pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;static&quot;); pyvista.start_xvfb() #try: &quot;none&quot;, &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#square half-length (m)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#number of finite elements along one half-side</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="mi">7932</span><span class="p">,</span> <span class="mi">3260</span><span class="p">,</span> <span class="mi">5960</span> <span class="c1">#core density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mf">0.008</span><span class="p">,</span> <span class="mf">0.003</span> <span class="c1">#core shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">500e3</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="mf">500e3</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c1">#angular frequency range (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#number of eigenvalues</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh and finite elements (six-node triangles with three dofs per node for the three components of displacement)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_rectangle</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">])],</span> 
                               <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">],</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">triangle</span><span class="p">)</span> <span class="c1">#MPI.COMM_SELF = FE mesh is built on each local process</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">))</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">k0</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k0_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k0_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is k, the eigenvalue is omega**2</span>
<span class="c1"># The parameter loop is parallelized</span>
<span class="c1"># Parallelization</span>
<span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span> <span class="c1">#use all processes for the loop</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>  <span class="c1">#number of processors</span>
<span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>  <span class="c1">#returns the rank of the process that called it within comm_world</span>
<span class="c1"># Split the parameter range and scatter to all</span>
<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#define on rank 0 only</span>
    <span class="n">param_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="c1">#split param in blocks of length size roughly</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">param_split</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">param_local</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">param_split</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#scatter 1 block per process</span>
<span class="c1"># Solve</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span> <span class="c1">#MPI.COMM_SELF = SLEPc will used FE matrices on each local process</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">param_local</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span>
<span class="c1"># Some post-processing</span>
<span class="n">wg</span><span class="o">.</span><span class="n">compute_energy_velocity</span><span class="p">()</span>
<span class="n">wg</span><span class="o">.</span><span class="n">compute_traveling_direction</span><span class="p">()</span>
<span class="c1"># Gather</span>
<span class="n">wg</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">],</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#reduce works for lists: brackets are necessary (wg.omega is not a list but a numpy array)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">energy_velocity</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">energy_velocity</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">traveling_direction</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">traveling_direction</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#wg.eigenvectors = comm.reduce(wg.eigenvectors, op=MPI.SUM, root=0) #don&#39;t do this line: reduce cannot pickle &#39;petsc4py.PETSc.Vec&#39; objects (keep the mode shapes distributed on each processor rather than gather them)</span>
<span class="c1"># Plot results</span>
<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">)</span> <span class="c1">#wg.omega is transformed to a numpy array for a proper use of wg.plot()</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">plot_energy_velocity</span><span class="p">(</span><span class="n">direction</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#plt.savefig(&quot;Elastic_Waveguide_Bar3D_ParallelizedLoop.svg&quot;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
</section>
<section id="three-dimensional-elastic-bar-of-square-cross-section-buried-into-a-pml-external-medium">
<h2>2. Three-dimensional elastic bar of square cross-section buried into a PML external medium<a class="headerlink" href="#three-dimensional-elastic-bar-of-square-cross-section-buried-into-a-pml-external-medium" title="Permalink to this heading"></a></h2>
<p>3D (visco-)elastic waveguide example.
The cross-section is a 2D square buried into a PML external elastic medium.
Material: viscoelastic steel into cement grout.
Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities.
The PML has a parabolic profile.
Results are to be compared with Fig. 8 of paper: Treyssede, Journal of Computational Physics 314 (2016), 341–354.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023-2024  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D (visco-)elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D square buried into a PML external elastic medium\</span>
<span class="c1"># Material: viscoelastic steel into cement grout\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities\</span>
<span class="c1"># The PML has a parabolic profile</span>
<span class="c1"># Results are to be compared with Fig. 8 of paper: Treyssede, Journal of Computational Physics 314 (2016), 341–354</span>

<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;static&quot;); pyvista.start_xvfb() #try: &quot;none&quot;, &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#core half-length (m)</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">a</span> <span class="c1">#half-length including PML (m)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1">#24 #number of finite elements along one half-side</span>
<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">N</span><span class="o">/</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The ratio a/b*N must be an integer, please adjust N&quot;</span><span class="p">)</span>
<span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="mi">7932</span><span class="p">,</span> <span class="mi">3260</span><span class="p">,</span> <span class="mi">5960</span> <span class="c1">#core density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas_core</span><span class="p">,</span> <span class="n">kappal_core</span> <span class="o">=</span> <span class="mf">0.008</span><span class="p">,</span> <span class="mf">0.003</span> <span class="c1">#core shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">1700</span><span class="p">,</span> <span class="mi">2810</span> <span class="c1">#for the external medium</span>
<span class="n">kappas_ext</span><span class="p">,</span> <span class="n">kappal_ext</span> <span class="o">=</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.043</span> <span class="c1">#for the external medium</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="n">j</span> <span class="c1">#average value of the absorbing function inside the PML</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">26e6</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="mf">1e3</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="c1">#angular frequencies (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#number of eigenvalues</span>
<span class="n">target</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">omega</span><span class="p">:</span> <span class="n">omega</span><span class="o">/</span><span class="n">cl_core</span><span class="o">.</span><span class="n">real</span> <span class="c1">#target set at the longitudinal wavenumber of core to find L(0,n) modes</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs_core</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho_core</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">b</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="n">rho_core</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs_core</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl_core</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="n">rho_ext</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs_ext</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl_ext</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="n">cs_core</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas_core</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl_core</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal_core</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>
<span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="n">cs_ext</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas_ext</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl_ext</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal_ext</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (exterior)</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh and finite elements (P2 quadrilaterals or order 8 GLL, with three dofs per node for the three components of displacement)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_rectangle</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">])],</span> 
                               <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">],</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">quadrilateral</span><span class="p">)</span>
<span class="c1">#element = ufl.VectorElement(&quot;CG&quot;, &quot;quadrilateral&quot;, 2, 3) #Lagrange element, quadrilateral, quadratic &quot;P2&quot;, 3D vector</span>
<span class="kn">import</span> <span class="nn">basix</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">create_element</span><span class="p">(</span><span class="n">basix</span><span class="o">.</span><span class="n">ElementFamily</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">basix</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">quadrilateral</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
                               <span class="n">basix</span><span class="o">.</span><span class="n">LagrangeVariant</span><span class="o">.</span><span class="n">gll_warped</span><span class="p">)</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl_wrapper</span><span class="o">.</span><span class="n">BasixElement</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl_wrapper</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties, discontinuous between core and exterior</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">]])</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span> <span class="c1">#the upper-triangle part of C (21 elements only)...</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#... stored as a column vector completed with zeros up to 36 elements (error otherwise)</span>
    <span class="k">return</span> <span class="n">C</span>
<span class="n">C_core</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span><span class="p">)</span>
<span class="n">C_ext</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">eval_C</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">C_core</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">)</span> \
           <span class="o">+</span> <span class="n">C_ext</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TensorElement</span><span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="s2">&quot;quadrilateral&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="c1">#symmetry enables to store 21 elements instead of 36</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">C</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">eval_C</span><span class="p">)</span> <span class="c1">#C.vector.getSize()) should be equal to number of cells x 21</span>
<span class="c1"># Same approach for density</span>
<span class="k">def</span> <span class="nf">eval_rho</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">rho_core</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">)</span> \
           <span class="o">+</span> <span class="n">rho_ext</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">rho</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">eval_rho</span><span class="p">)</span>
<span class="c1"># Vizualization</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">600</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
<span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Cij&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="c1">#index from 0 to 20, 0 being for C11...</span>
<span class="c1">#grid.cell_data[&quot;Cij&quot;] = rho.x.array.real #for checking density</span>
<span class="n">grid</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Cij&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Re(Cij)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create Cartesian PML functions, continuous</span>
<span class="k">def</span> <span class="nf">eval_gamma</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="c1">#pml profile: continuous and parabolic</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">),</span> <span class="c1">#gammax</span>
              <span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">)]</span> <span class="c1">#gammay</span>
    <span class="k">return</span> <span class="n">values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;quadrilateral&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">gamma</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">eval_gamma</span><span class="p">)</span>
<span class="c1"># Vizualization</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">gridx</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
<span class="n">gridx</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;gammax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>
<span class="n">gridx</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;gammax&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">gridx</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Im(gammax)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">gridy</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
<span class="n">gridy</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;gammay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>
<span class="n">gridy</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;gammay&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">gridy</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Im(gammay)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions (or uncomment lines below for Dirichlet)</span>
<span class="c1"># bcs = []</span>
<span class="c1"># Dirichlet test case:</span>
<span class="n">fdim</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">locate_entities_boundary</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">fdim</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">b</span><span class="p">),</span>
                                                                                                       <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">+</span>
                                                                                                       <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">+</span>
                                                                                                       <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">+</span><span class="n">b</span><span class="p">)))</span>
<span class="n">boundary_dofs</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">entity_dim</span><span class="o">=</span><span class="n">fdim</span><span class="p">,</span> <span class="n">entities</span><span class="o">=</span><span class="n">boundary_facets</span><span class="p">)</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">),</span> <span class="n">dofs</span><span class="o">=</span><span class="n">boundary_dofs</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">)]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lx</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">Ly</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">gammax</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gammay</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">k0</span> <span class="o">=</span> <span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">gammay</span><span class="o">/</span><span class="n">gammax</span><span class="o">*</span><span class="n">Lx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="n">Ly</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">Lx</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">Lx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="n">gammax</span><span class="o">/</span><span class="n">gammay</span><span class="o">*</span><span class="n">Ly</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">Ly</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k0_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
<span class="n">k1</span> <span class="o">=</span> <span class="p">(</span><span class="n">gammay</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lx</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">+</span><span class="n">gammax</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Ly</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">gammax</span> <span class="o">*</span> <span class="n">gammay</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">gammax</span> <span class="o">*</span> <span class="n">gammay</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k0_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is omega, the eigenvalue is k</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">evp</span><span class="o">.</span><span class="n">setWhichEigenpairs</span><span class="p">(</span><span class="n">SLEPc</span><span class="o">.</span><span class="n">PEP</span><span class="o">.</span><span class="n">Which</span><span class="o">.</span><span class="n">TARGET_MAGNITUDE</span><span class="p">)</span> <span class="c1">#here, preferred to TARGET_IMAGINARY</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Plot dispersion curves\</span>
<span class="c1"># Results are to be compared with Fig. 8 of Treyssede, Journal of Computational Physics 314 (2016), 341–354</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot_scaler</span><span class="p">[</span><span class="s2">&quot;energy_velocity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L0</span><span class="o">/</span><span class="n">T0</span><span class="o">/</span><span class="mi">1000</span> <span class="c1">#units in m/ms</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot_scaler</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L0</span><span class="o">/</span><span class="n">T0</span><span class="o">/</span><span class="mi">1000</span> <span class="c1">#frequency units in MHz-mm</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_energy_velocity</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">])</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency-halfwidth (MHz-mm)&#39;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Energy velocity (m/ms)&#39;</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot_scaler</span><span class="p">[</span><span class="s2">&quot;attenuation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.686</span><span class="o">*</span><span class="mi">1000</span> <span class="c1">#units in dB-mm/m</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_attenuation</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">])</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span><span class="p">])</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency-halfwidth (MHz-mm)&#39;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Attenuation (dB-mm/m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">#wg.plot_spectrum(index=0)</span>
<span class="c1">#plt.show()</span>

<span class="c1">##################################</span>
<span class="c1"># Mode shape visualization</span>
<span class="n">ik</span><span class="p">,</span> <span class="n">imode</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span> <span class="c1">#parameter index, mode index to visualize</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">getColumnVector</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span>
<span class="n">u_grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">))</span> <span class="c1">#V.element.value_shape is equal to 3</span>
<span class="n">u_plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">u_grid</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#do not show edges of higher order elements with pyvista</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="three-dimensional-elastic-bar-of-square-cross-section-buried-into-a-pml-external-medium-using-gmsh">
<h2>3. Three-dimensional elastic bar of square cross-section buried into a PML external medium using gmsh<a class="headerlink" href="#three-dimensional-elastic-bar-of-square-cross-section-buried-into-a-pml-external-medium-using-gmsh" title="Permalink to this heading"></a></h2>
<p>3D (visco-)elastic waveguide example.
The cross-section is a 2D square buried into a PML external elastic medium.
Material: viscoelastic steel into cement grout.
Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities.
The PML has a parabolic profile.
The FE mesh is built from Gmsh.
Results are to be compared with Fig. 8 of paper: Treyssede, Journal of Computational Physics 314 (2016), 341–354.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023-2024  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D (visco-)elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D square buried into a PML external elastic medium\</span>
<span class="c1"># Material: viscoelastic steel into cement grout\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities\</span>
<span class="c1"># The PML has a parabolic profile\</span>
<span class="c1"># The FE mesh is built from Gmsh\</span>
<span class="c1"># Results are to be compared with Fig. 8 of paper: Treyssede, Journal of Computational Physics 314 (2016), 341–354</span>

<span class="kn">import</span> <span class="nn">gmsh</span> <span class="c1">#full documentation entirely defined in the `gmsh.py&#39; module</span>
<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;static&quot;); pyvista.start_xvfb() #try: &quot;none&quot;, &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#core half-length (m)</span>
<span class="n">b</span><span class="p">,</span> <span class="n">le</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="mi">4</span> <span class="c1">#half-length including PML (m), finite element characteristic length (m)</span>
<span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="mi">7932</span><span class="p">,</span> <span class="mi">3260</span><span class="p">,</span> <span class="mi">5960</span> <span class="c1">#core density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas_core</span><span class="p">,</span> <span class="n">kappal_core</span> <span class="o">=</span> <span class="mf">0.008</span><span class="p">,</span> <span class="mf">0.003</span> <span class="c1">#core shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">1700</span><span class="p">,</span> <span class="mi">2810</span> <span class="c1">#for the external medium</span>
<span class="n">kappas_ext</span><span class="p">,</span> <span class="n">kappal_ext</span> <span class="o">=</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.043</span> <span class="c1">#for the external medium</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="n">j</span> <span class="c1">#average value of the absorbing function inside the PML</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">26e6</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="mf">1e3</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span> <span class="c1">#angular frequencies (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#number of eigenvalues</span>
<span class="n">target</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">omega</span><span class="p">:</span> <span class="n">omega</span><span class="o">/</span><span class="n">cl_core</span><span class="o">.</span><span class="n">real</span> <span class="c1">#target set at the longitudinal wavenumber of core to find L(0,n) modes</span>
<span class="n">cell_type</span> <span class="o">=</span> <span class="s1">&#39;quadrilateral&#39;</span> <span class="c1">#&#39;triangle&#39;, &#39;quadrilateral&#39;</span>
<span class="n">gll</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#False: Lagrange 2nd order element, True: 8th order element with Gauss-Lobatto-Legendre points (spectral-like)</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs_core</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho_core</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">b</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">le</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="n">rho_core</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs_core</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl_core</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="n">rho_ext</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs_ext</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl_ext</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="n">cs_core</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas_core</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl_core</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal_core</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>
<span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="n">cs_ext</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas_ext</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl_ext</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal_ext</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (exterior)</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh from Gmsh and finite elements (six-node triangles with three dofs per node for the three components of displacement)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="c1"># Core</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">core</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># External medium</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">exterior</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="c1"># Physical groups</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span> <span class="c1">#the CAD entities must be synchronized with the Gmsh model</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">core</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2: for 2D (surface)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">exterior</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#2: for 2D (surface)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span> <span class="c1">#1: for 1D (line)</span>
<span class="c1"># Generate mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#generate a 2D mesh</span>
<span class="k">if</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s1">&#39;quadrilateral&#39;</span><span class="p">:</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">recombine</span><span class="p">()</span> <span class="c1">#recombine into quadrilaterals</span>
<span class="c1">#gmsh.model.mesh.setOrder(2) #interpolation order for the geometry, here 2nd order</span>
<span class="c1"># From gmsh to fenicsx</span>
<span class="n">mesh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">,</span> <span class="n">facet_tags</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gmshio</span><span class="o">.</span><span class="n">model_to_mesh</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gdim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># # Reminder for save &amp; read</span>
<span class="c1"># gmsh.write(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;) #save to disk</span>
<span class="c1"># mesh, cell_tags, facet_tags = dolfinx.io.gmshio.read_from_msh(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;, MPI.COMM_WORLD, rank=0, gdim=2)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span> <span class="c1">#called when done using the Gmsh Python API</span>
<span class="c1"># Finite element space</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">gll</span><span class="p">:</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector</span>
<span class="k">else</span><span class="p">:</span> <span class="c1">#spectral element-like</span>
    <span class="kn">import</span> <span class="nn">basix</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">create_element</span><span class="p">(</span><span class="n">basix</span><span class="o">.</span><span class="n">ElementFamily</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">basix</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">quadrilateral</span> <span class="k">if</span> <span class="n">cell_type</span><span class="o">==</span><span class="s1">&#39;quadrilateral&#39;</span> <span class="k">else</span> <span class="n">basix</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">triangle</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
                                   <span class="n">basix</span><span class="o">.</span><span class="n">LagrangeVariant</span><span class="o">.</span><span class="n">gll_warped</span><span class="p">)</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl_wrapper</span><span class="o">.</span><span class="n">BasixElement</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl_wrapper</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
<span class="c1"># Visualize FE mesh with pyvista</span>
<span class="n">Vmesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">#cell of order 1 is properly handled with pyvista</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Vmesh</span><span class="p">))</span>
<span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">values</span>
<span class="n">grid</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Marker&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">grid_nodes</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span> <span class="c1">#add higher-order nodes</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid_nodes</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">render_points_as_spheres</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties, discontinuous between core and exterior</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">]])</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span> <span class="c1">#the upper-triangle part of C (21 elements only)</span>
    <span class="k">return</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
<span class="n">C_core</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span><span class="p">)</span>
<span class="n">C_ext</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TensorElement</span><span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="c1">#symmetry enables to store 21 elements instead of 36</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">cells</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#core (tag=1)</span>
<span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[[</span><span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="o">*</span><span class="n">c</span><span class="p">,</span><span class="mi">21</span><span class="o">*</span><span class="n">c</span><span class="o">+</span><span class="mi">21</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">C_core</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<span class="n">cells</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#exterior (tag=2)</span>
<span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[[</span><span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="o">*</span><span class="n">c</span><span class="p">,</span><span class="mi">21</span><span class="o">*</span><span class="n">c</span><span class="o">+</span><span class="mi">21</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">C_ext</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># Same approach for density</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">cells</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#core (tag=1)</span>
<span class="n">rho</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">rho_core</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">))</span>
<span class="n">cells</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#exterior (tag=2)</span>
<span class="n">rho</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">rho_ext</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">))</span>
<span class="c1"># Vizualization</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">600</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
<span class="n">gridC</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span> <span class="c1">#or *dolfinx.plot.create_vtk_mesh(Vmesh)</span>
<span class="n">gridC</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Cij&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="c1">#index from 0 to 35, 0 being for C11...</span>
<span class="c1">#gridC.cell_data[&quot;Cij&quot;] = rho.x.array.real #for checking density</span>
<span class="n">gridC</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Cij&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh (with vertices of order 1 elements only owing to pyvista) </span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">gridC</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Re(Cij)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create Cartesian PML functions, continuous</span>
<span class="k">def</span> <span class="nf">eval_gamma</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="c1">#pml profile: continuous and parabolic</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">),</span> <span class="c1">#gammax</span>
              <span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">)]</span> <span class="c1">#gammay</span>
    <span class="k">return</span> <span class="n">values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">gamma</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">eval_gamma</span><span class="p">)</span>
<span class="c1"># Vizualization</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">gridx</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
<span class="n">gridx</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;gammax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>
<span class="n">gridx</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;gammax&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">gridx</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Im(gammax)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">gridy</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
<span class="n">gridy</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;gammay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>
<span class="n">gridy</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;gammay&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">gridy</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Im(gammay)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions (or uncomment lines below for Dirichlet)</span>
<span class="c1"># bcs = []</span>
<span class="c1"># Dirichlet test case:</span>
<span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span> <span class="c1">#outer boundary (tag=21)</span>
<span class="n">boundary_dofs</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">entity_dim</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">entities</span><span class="o">=</span><span class="n">boundary_facets</span><span class="p">)</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">),</span> <span class="n">dofs</span><span class="o">=</span><span class="n">boundary_dofs</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">)]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="c1">#ufl.dx = ufl.dx(metadata={&quot;quadrature_rule&quot;: &quot;GLL&quot;, &quot;quadrature_degree&quot;: 2*(8-1)}) if gll else ufl.dx #uncomment to build diagonal mass matrix</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lx</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">Ly</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">gammax</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gammay</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">k0</span> <span class="o">=</span> <span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">gammay</span><span class="o">/</span><span class="n">gammax</span><span class="o">*</span><span class="n">Lx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="n">Ly</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">Lx</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">Lx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="n">gammax</span><span class="o">/</span><span class="n">gammay</span><span class="o">*</span><span class="n">Ly</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">Ly</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k0_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
<span class="n">k1</span> <span class="o">=</span> <span class="p">(</span><span class="n">gammay</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lx</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">+</span><span class="n">gammax</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Ly</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">gammax</span> <span class="o">*</span> <span class="n">gammay</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">gammax</span> <span class="o">*</span> <span class="n">gammay</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k0_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is omega, the eigenvalue is k</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="c1">#(K2, M) = (wg._diag(K2.getDiagonal()), wg._diag(M.getDiagonal())) if gll else (K2, M) ##uncomment to save allocated memory of K2 and M if they are to be diagonal</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">evp</span><span class="o">.</span><span class="n">setWhichEigenpairs</span><span class="p">(</span><span class="n">SLEPc</span><span class="o">.</span><span class="n">PEP</span><span class="o">.</span><span class="n">Which</span><span class="o">.</span><span class="n">TARGET_MAGNITUDE</span><span class="p">)</span> <span class="c1">#here, preferred to TARGET_IMAGINARY</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Plot dispersion curves\</span>
<span class="c1"># Results are to be compared with Fig. 8 of Treyssede, Journal of Computational Physics 314 (2016), 341–354</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot_scaler</span><span class="p">[</span><span class="s2">&quot;energy_velocity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L0</span><span class="o">/</span><span class="n">T0</span><span class="o">/</span><span class="mi">1000</span> <span class="c1">#units in m/ms</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot_scaler</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L0</span><span class="o">/</span><span class="n">T0</span><span class="o">/</span><span class="mi">1000</span> <span class="c1">#frequency units in MHz-mm</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_energy_velocity</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">])</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency-halfwidth (MHz-mm)&#39;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Energy velocity (m/ms)&#39;</span><span class="p">)</span>
<span class="c1">#plt.savefig(&quot;buried_bar_energy_velocity.png&quot;)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot_scaler</span><span class="p">[</span><span class="s2">&quot;attenuation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.686</span><span class="o">*</span><span class="mi">1000</span> <span class="c1">#units in dB-mm/m</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_attenuation</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">])</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span><span class="p">])</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency-halfwidth (MHz-mm)&#39;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Attenuation (dB-mm/m)&#39;</span><span class="p">)</span>
<span class="c1">#plt.savefig(&quot;buried_bar_attenuation.png&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">#wg.plot_spectrum(index=0)</span>
<span class="c1">#plt.show()</span>

<span class="c1">##################################</span>
<span class="c1"># Mode shape visualization</span>
<span class="n">ik</span><span class="p">,</span> <span class="n">imode</span> <span class="o">=</span> <span class="mi">345</span><span class="p">,</span> <span class="mi">0</span> <span class="c1">#parameter index, mode index to visualize</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;f=</span><span class="si">{</span><span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">*</span><span class="n">L0</span><span class="o">/</span><span class="n">T0</span><span class="o">/</span><span class="mi">1000</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="si">:</span><span class="s2">1.1f</span><span class="si">}</span><span class="s2">MHz-mm, attenuation=</span><span class="si">{</span><span class="mf">8.686</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">imode</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="si">:</span><span class="s2">1.2f</span><span class="si">}</span><span class="s2">dB-mm/m&quot;</span><span class="p">)</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">getColumnVector</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span>
<span class="n">u_grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">))</span> <span class="c1">#V.element.value_shape is equal to 3</span>
<span class="n">u_plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">u_grid</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span> <span class="c1">#do not show edges of higher order elements with pyvista</span>
<span class="c1">#u_plotter.show_axes()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">screenshot</span><span class="p">(</span><span class="s1">&#39;buried_bar_mode_shape.png&#39;</span><span class="p">,</span> <span class="n">transparent_background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="s2">&quot;&quot;</span>

</pre></div>
</div>
</section>
<section id="excitation-of-a-three-dimensional-elastic-bar-of-circular-cross-section">
<h2>4. Excitation of a three-dimensional elastic bar of circular cross-section<a class="headerlink" href="#excitation-of-a-three-dimensional-elastic-bar-of-circular-cross-section" title="Permalink to this heading"></a></h2>
<p>3D elastic waveguide example.
The cross-section is a 2D circle with free boundary conditions on its 1D boundaries, material: elastic steel.
The eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers).
The forced response is computed for a point force at the center node ot the cross-section.
Results are to be compared with Figs. 5, 6 and 7 of paper: Treyssede, Wave Motion 87 (2019), 75-91.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023-2024  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D circle with free boundary conditions on its 1D boundaries, material: elastic steel\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># This eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers).\</span>
<span class="c1"># The forced response is computed for a point force at the center node ot the cross-section.\</span>
<span class="c1"># Results are to be compared with Figs. 5, 6 and 7 of paper: Treyssede, Wave Motion 87 (2019), 75-91.</span>

<span class="kn">import</span> <span class="nn">gmsh</span> <span class="c1">#full documentation entirely defined in the `gmsh.py&#39; module</span>
<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;static&quot;); pyvista.start_xvfb() #try: &quot;none&quot;, &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#cross-section radius (m)</span>
<span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="mi">8</span> <span class="c1">#finite element characteristic length (m)</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="mi">7800</span><span class="p">,</span> <span class="mi">3296</span><span class="p">,</span> <span class="mi">5963</span> <span class="c1">#density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.008</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.003</span> <span class="c1">#shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">*</span><span class="n">cs</span><span class="o">/</span><span class="n">a</span> <span class="c1">#angular frequencies (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1">#number of eigenvalues</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span><span class="p">,</span> <span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">le</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh from Gmsh and finite elements (six-node triangles with three dofs per node for the three components of displacement)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="c1"># Core</span>
<span class="n">origin</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">disk</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># Physical groups</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span> <span class="c1">#the CAD entities must be synchronized with the Gmsh model</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">disk</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2: for 2D (surface)</span>
<span class="c1">#gmsh.model.addPhysicalGroup(1, [1, 2, 3, 4], tag=11) #1: for 1D (line)</span>
<span class="c1"># Generate mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">origin</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">disk</span><span class="p">)</span> <span class="c1">#ensure node points at the origin</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#generate a 2D mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setOrder</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#interpolation order for the geometry, here 2nd order</span>
<span class="c1"># From gmsh to fenicsx</span>
<span class="n">mesh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">,</span> <span class="n">facet_tags</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gmshio</span><span class="o">.</span><span class="n">model_to_mesh</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gdim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># # Reminder for save &amp; read</span>
<span class="c1"># gmsh.write(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;) #save to disk</span>
<span class="c1"># mesh, cell_tags, facet_tags = dolfinx.io.gmshio.read_from_msh(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;, MPI.COMM_WORLD, rank=0, gdim=2)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span> <span class="c1">#called when done using the Gmsh Python API</span>
<span class="c1"># Finite element space</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
<span class="c1"># Visualize FE mesh with pyvista</span>
<span class="n">Vmesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">#order 1 is properly handled with pyvista</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Vmesh</span><span class="p">))</span>
<span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">values</span>
<span class="n">grid</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Marker&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">grid_nodes</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span> <span class="c1">#add higher-order nodes</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid_nodes</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">render_points_as_spheres</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">]])</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">k0</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k0_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k0_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc (the parameter is omega, the eigenvalue is k)</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">,</span> <span class="n">two_sided</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">evp</span><span class="o">.</span><span class="n">setTolerances</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">max_it</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="o">=</span><span class="n">nev</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]</span>

<span class="c1">##################################</span>
<span class="c1"># Plot dispersion curves\</span>
<span class="c1"># Results are to be compared with Fig. 5 of Treyssede, Wave Motion 87 (2019), 75-91</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot_energy_velocity</span><span class="p">(</span><span class="n">direction</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Excitation force definition (point force)</span>
<span class="n">dof_coords</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">tabulate_dof_coordinates</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1">#desired coordinate of point force</span>
<span class="n">dof</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dof_coords</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span> <span class="c1">#find nearest dof</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Point force coordinates (nearest dof):  </span><span class="si">{</span><span class="p">(</span><span class="n">dof_coords</span><span class="p">[</span><span class="n">dof</span><span class="p">,:])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#check</span>
<span class="n">F0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">createVecRight</span><span class="p">()</span>
<span class="n">dof</span> <span class="o">=</span> <span class="n">dof</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="c1">#orientation along z</span>
<span class="c1">#dof = dof - 2 #uncomment this line for an orientation along x instead</span>
<span class="n">F0</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1">##Uncomment lines below for distributed excitation</span>
<span class="c1">#body_force = dolfinx.fem.Constant(mesh, PETSc.ScalarType((0, 0, 1))) #body force of unit amplitude along z</span>
<span class="c1">#traction = dolfinx.fem.Constant(mesh, PETSc.ScalarType((0, 0, 0))) #zero traction</span>
<span class="c1">#ds = ufl.Measure(&quot;ds&quot;, domain=mesh)</span>
<span class="c1">#f = ufl.inner(body_force, v) * ufl.dx + ufl.inner(traction, v) * ds</span>
<span class="c1">#f_form = dolfinx.fem.form(f)</span>
<span class="c1">#F = dolfinx.fem.petsc.assemble_vector(f_form)</span>
<span class="c1">#F.assemble()</span>

<span class="c1">##################################</span>
<span class="c1"># Computation of excitability and forced response\</span>
<span class="c1"># Results are to be compared with Figs. 6 and 7 of Treyssede, Wave Motion 87 (2019), 75-91</span>
<span class="n">wg</span><span class="o">.</span><span class="n">compute_response_coefficient</span><span class="p">(</span><span class="n">F</span><span class="o">=</span><span class="n">F0</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot_coefficient</span><span class="p">()</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_excitability</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span><span class="mf">0.5e+1</span><span class="p">)</span>
<span class="n">frequency</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">ll_abs</span><span class="p">,</span> <span class="n">ll_angle</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">compute_response</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#spectrum=excitation.spectrum</span>
<span class="n">ll_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ll_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span><span class="mf">1e+1</span><span class="p">)</span>
<span class="n">ll_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Mode shape visualization</span>
<span class="n">ik</span><span class="p">,</span> <span class="n">imode</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span> <span class="c1">#parameter index, mode index to visualize</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">getColumnVector</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span>
<span class="n">u_grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">))</span> <span class="c1">#V.element.value_shape is equal to 3</span>
<span class="n">u_plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">u_grid</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#do not show edges of higher order elements with pyvista</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="excitation-of-a-three-dimensional-elastic-bar-of-circular-cross-section-with-parallelization">
<h2>5. Excitation of a three-dimensional elastic bar of circular cross-section with parallelization<a class="headerlink" href="#excitation-of-a-three-dimensional-elastic-bar-of-circular-cross-section-with-parallelization" title="Permalink to this heading"></a></h2>
<p>3D elastic waveguide example.
The cross-section is a 2D circle with free boundary conditions on its 1D boundaries, material: elastic steel.
The eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers).
The forced response is computed for a point force at the center node ot the cross-section.
Results are to be compared with Figs. 5, 6 and 7 of paper: Treyssede, Wave Motion 87 (2019), 75-91.
In this example:</p>
<ul class="simple">
<li><p>the parameter loop (here, the frequency loop) is distributed on all processes</p></li>
<li><p>FE mesh and matrices are built on each local process</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023-2024  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D circle with free boundary conditions on its 1D boundaries, material: elastic steel\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># This eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers).\</span>
<span class="c1"># The forced response is computed for a point force at the center node ot the cross-section.\</span>
<span class="c1"># Results are to be compared with Figs. 5, 6 and 7 of paper: Treyssede, Wave Motion 87 (2019), 75-91.</span>
<span class="c1"># In this example:</span>
<span class="c1"># - the parameter loop (here, the frequency loop) is distributed on all processes</span>
<span class="c1"># - FE mesh and matrices are built on each local process</span>
<span class="c1"># Reminder for an execution in parallel mode (e.g. 8 processes):</span>
<span class="c1">#  mpiexec -n 8 python3 Elastic_Waveguide_CircularBar3D_ForcedResponse_Gmsh_ParallelizedLoop.py</span>

<span class="kn">import</span> <span class="nn">gmsh</span> <span class="c1">#full documentation entirely defined in the `gmsh.py&#39; module</span>
<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1">#import pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;static&quot;); pyvista.start_xvfb() #try: &quot;none&quot;, &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#cross-section radius (m)</span>
<span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="mi">8</span> <span class="c1">#finite element characteristic length (m)</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="mi">7800</span><span class="p">,</span> <span class="mi">3296</span><span class="p">,</span> <span class="mi">5963</span> <span class="c1">#density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.008</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.003</span> <span class="c1">#shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">*</span><span class="n">cs</span><span class="o">/</span><span class="n">a</span> <span class="c1">#angular frequencies (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">300</span> <span class="c1">#number of eigenvalues</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span><span class="p">,</span> <span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">le</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh from Gmsh and finite elements (six-node triangles with three dofs per node for the three components of displacement)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="c1"># Core</span>
<span class="n">origin</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">disk</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># Physical groups</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span> <span class="c1">#the CAD entities must be synchronized with the Gmsh model</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">disk</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2: for 2D (surface)</span>
<span class="c1">#gmsh.model.addPhysicalGroup(1, [1, 2, 3, 4], tag=11) #1: for 1D (line)</span>
<span class="c1"># Generate mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">origin</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">disk</span><span class="p">)</span> <span class="c1">#ensure node points at the origin</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#generate a 2D mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setOrder</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#interpolation order for the geometry, here 2nd order</span>
<span class="c1"># From gmsh to fenicsx</span>
<span class="n">mesh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">,</span> <span class="n">facet_tags</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gmshio</span><span class="o">.</span><span class="n">model_to_mesh</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gdim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#MPI.COMM_SELF = FE mesh is built on each local process</span>
<span class="c1"># # Reminder for save &amp; read</span>
<span class="c1"># gmsh.write(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;) #save to disk</span>
<span class="c1"># mesh, cell_tags, facet_tags = dolfinx.io.gmshio.read_from_msh(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;, MPI.COMM_WORLD, rank=0, gdim=2)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span> <span class="c1">#called when done using the Gmsh Python API</span>
<span class="c1"># Finite element space</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">]])</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">k0</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k0_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k0_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Excitation force definition (point force)</span>
<span class="n">dof_coords</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">tabulate_dof_coordinates</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1">#desired coordinate of point force</span>
<span class="n">dof</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dof_coords</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span> <span class="c1">#find nearest dof</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Point force coordinates (nearest dof):  </span><span class="si">{</span><span class="p">(</span><span class="n">dof_coords</span><span class="p">[</span><span class="n">dof</span><span class="p">,:])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#check</span>
<span class="n">F0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">createVecRight</span><span class="p">()</span>
<span class="n">dof</span> <span class="o">=</span> <span class="n">dof</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="c1">#orientation along z</span>
<span class="n">dof</span> <span class="o">=</span> <span class="n">dof</span> <span class="o">-</span> <span class="mi">2</span> <span class="c1">#uncomment this line for an orientation along x instead</span>
<span class="n">F0</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1">##Uncomment lines below for distributed excitation</span>
<span class="c1">#body_force = dolfinx.fem.Constant(mesh, PETSc.ScalarType((0, 0, 1))) #body force of unit amplitude along z</span>
<span class="c1">#traction = dolfinx.fem.Constant(mesh, PETSc.ScalarType((0, 0, 0))) #zero traction</span>
<span class="c1">#ds = ufl.Measure(&quot;ds&quot;, domain=mesh)</span>
<span class="c1">#f = ufl.inner(body_force, v) * ufl.dx + ufl.inner(traction, v) * ds</span>
<span class="c1">#f_form = dolfinx.fem.form(f)</span>
<span class="c1">#F = dolfinx.fem.petsc.assemble_vector(f_form)</span>
<span class="c1">#F.assemble()</span>

<span class="c1">##################################</span>
<span class="c1"># Parallelization</span>
<span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span> <span class="c1">#use all processes for the loop</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>  <span class="c1">#number of processors</span>
<span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>  <span class="c1">#returns the rank of the process that called it within comm_world</span>
<span class="c1"># Split the parameter range and scatter to all</span>
<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#define on rank 0 only</span>
    <span class="n">omega_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="c1">#split param in blocks of length size roughly</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">omega_split</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">omega_local</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">omega_split</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#scatter 1 block per process</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc (the parameter is omega, the eigenvalue is k)</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span> <span class="c1">#MPI.COMM_SELF = SLEPc will used FE matrices on each local process</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega_local</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">evp</span><span class="o">.</span><span class="n">setTolerances</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">max_it</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="o">=</span><span class="n">nev</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]</span>

<span class="c1">##################################</span>
<span class="c1"># Computation of excitability and forced response</span>
<span class="n">wg</span><span class="o">.</span><span class="n">compute_response_coefficient</span><span class="p">(</span><span class="n">F</span><span class="o">=</span><span class="n">F0</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
<span class="n">frequency</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">compute_response</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#spectrum=excitation.spectrum</span>

<span class="c1">##################################</span>
<span class="c1"># Gather</span>
<span class="n">wg</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">],</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#reduce works for lists: brackets are necessary (wg.omega is not a list but a numpy array)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#wg.eigenvectors = comm.reduce(wg.eigenvectors, op=MPI.SUM, root=0) #don&#39;t do this line: reduce cannot pickle &#39;petsc4py.PETSc.Vec&#39; objects (keep the mode shapes distributed on each processor rather than gather them)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">coefficient</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">coefficient</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">excitability</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">excitability</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">frequency</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">frequency</span><span class="p">],</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">response</span><span class="p">],</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Plots</span>
<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">)</span> <span class="c1">#wg.omega is transformed to a numpy array for a proper use of wg.plot()</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">plot_coefficient</span><span class="p">()</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_excitability</span><span class="p">()</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span><span class="mf">0.5e+1</span><span class="p">)</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="c1">#use np.concatenate(response, axis=1)  if z contains more than one value</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;frequency&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;|u|&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span><span class="mf">1e+1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1">#plt.savefig(&quot;figure_name.svg&quot;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
</section>
<section id="time-response-of-a-two-dimensional-plate-excited-near-its-first-zgv-resonance">
<h2>6. Time response of a two-dimensional plate excited near its first ZGV resonance<a class="headerlink" href="#time-response-of-a-two-dimensional-plate-excited-near-its-first-zgv-resonance" title="Permalink to this heading"></a></h2>
<p>2D (visco-)elastic waveguide example (Lamb modes in a plate excited near 1st ZGV resonance).
The cross-section is a 1D line with free boundary conditions on its boundaries.
Material: viscoelastic steel.
The eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers).
Viscoelastic loss can be included by introducing imaginary parts (negative) to wave celerities.
Results are to be compared with Figs. 5b, 7a and 8a of paper: Treyssede and Laguerre, JASA 133 (2013), 3827-3837.
Note: the depth direction is x, the axis of propagation is z.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023-2024  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 2D (visco-)elastic waveguide example (Lamb modes in a plate excited near 1st ZGV resonance)\</span>
<span class="c1"># The cross-section is a 1D line with free boundary conditions on its boundaries\</span>
<span class="c1"># material: viscoelastic steel\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># This eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers)\</span>
<span class="c1"># Viscoelastic loss can be included by introducing imaginary parts (negative) to wave celerities\</span>
<span class="c1"># Results are to be compared with Figs. 5b, 7a and 8a of paper: Treyssede and Laguerre, JASA 133 (2013), 3827-3837\</span>
<span class="c1"># Note: the depth direction is x, the axis of propagation is z</span>

<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span><span class="p">,</span> <span class="n">Signal</span>
<span class="c1">#For proper use with a notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;static&quot;); pyvista.start_xvfb() #try: &quot;none&quot;, &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">h</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1">#plate thickness (m)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#number of finite elements along one half-side</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="mi">7800</span><span class="p">,</span> <span class="mi">3218</span><span class="p">,</span> <span class="mi">6020</span> <span class="c1">#core density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.008</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.003</span> <span class="c1">#core shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#number of eigenvalues</span>

<span class="c1">##################################</span>
<span class="c1"># Excitation spectrum</span>
<span class="n">excitation</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">/</span><span class="mf">5e-3</span><span class="p">)</span>
<span class="n">excitation</span><span class="o">.</span><span class="n">toneburst</span><span class="p">(</span><span class="n">fs</span><span class="o">=</span><span class="mf">1000e3</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="mf">250e3</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">excitation</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">excitation</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">()</span>
<span class="c1">#excitation.ifft(coeff=1); excitation.plot() #uncomment for check only</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">excitation</span><span class="o">.</span><span class="n">frequency</span> <span class="c1">#angular frequency range (rad/s)</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">h</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">h</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh and finite elements (three-node lines with two dofs per node for the two components of displacement)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_interval</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">]))</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#Lagrange element, line element, quadratic &quot;P2&quot;, 2D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C33</span><span class="p">))</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span>
<span class="n">Lz</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">k0</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k0_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k0_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is omega, the eigenvalue is k</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span> <span class="c1">#access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1">#blocking</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Excitation force: point force at x=0 oriented in the x-direction</span>
<span class="n">dof_coords</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">tabulate_dof_coordinates</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1">#desired coordinate of point force</span>
<span class="n">dof</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dof_coords</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span> <span class="c1">#find nearest dof</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Point force coordinates (nearest dof):  </span><span class="si">{</span><span class="p">(</span><span class="n">dof_coords</span><span class="p">[</span><span class="n">dof</span><span class="p">,:])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#check</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">createVecRight</span><span class="p">()</span>
<span class="n">dof</span> <span class="o">=</span> <span class="n">dof</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">0</span> <span class="c1">#x-direction</span>
<span class="n">F</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Computation of excitabilities and forced response\</span>
<span class="c1"># Results are to be compared with Figs. 5b and 7a of Treyssede and Laguerre, JASA 133 (2013), 3827-3837</span>
<span class="n">wg</span><span class="o">.</span><span class="n">compute_response_coefficient</span><span class="p">(</span><span class="n">F</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_plot_scaler</span><span class="p">()</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_excitability</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span><span class="mf">1e2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_plot_scaler</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">L0</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">M0</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#to visualize dimensional results</span>
<span class="n">frequency</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">ll_abs</span><span class="p">,</span> <span class="n">ll_angle</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">compute_response</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="n">excitation</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ll_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">ll_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5e6</span><span class="p">])</span>
<span class="n">ll_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Time response\</span>
<span class="c1"># Results are to be compared with Fig. 8a of Treyssede and Laguerre, JASA 133 (2013), 3827-3837</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">/</span><span class="mf">5e-3</span><span class="o">*</span><span class="n">T0</span><span class="p">)</span>
<span class="c1">#response.plot_spectrum()</span>
<span class="n">response</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">5e-3</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">2e-3</span><span class="p">,</span> <span class="mf">2e-3</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;displacement (m)&#39;</span><span class="p">)</span>
<span class="c1">#plt.savefig(&#39;plate_zgv_transient.png&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Mesh visualization</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">render_points_as_spheres</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Mode shape visualization</span>
<span class="n">ik</span><span class="p">,</span> <span class="n">imode</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">5</span> <span class="c1">#parameter index, mode index to visualize</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">getColumnVector</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span><span class="o">*</span><span class="n">wg</span><span class="o">.</span><span class="n">plot_scaler</span><span class="p">[</span><span class="s2">&quot;eigenvectors&quot;</span><span class="p">]</span> <span class="c1">#note: multiplying by wg.plot_scaler[&quot;eigenvectors&quot;] enables to normalize the cross-section power flow of eigenmodes to 1 Watt(/m)</span>
<span class="n">u_grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">))</span> <span class="c1">#V.element.value_shape is equal to 2</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#insert a zero column to the second component (the y component)</span>
<span class="n">u_plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">u_grid</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#do not show edges of higher order elements with pyvista</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">view_zx</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Save matrices into file (for basic usage of waveguicsx, see README examples)</span>
<span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span><span class="o">.</span><span class="n">createBinary</span><span class="p">(</span><span class="s1">&#39;BasicExample.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">viewer</span><span class="o">=</span><span class="n">viewer</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">viewer</span><span class="o">=</span><span class="n">viewer</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">viewer</span><span class="o">=</span><span class="n">viewer</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">viewer</span><span class="o">=</span><span class="n">viewer</span><span class="p">)</span>
<span class="n">F</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">viewer</span><span class="o">=</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="dispersion-curves-of-a-rail">
<h2>7. Dispersion curves of a rail<a class="headerlink" href="#dispersion-curves-of-a-rail" title="Permalink to this heading"></a></h2>
<p>3D elastic waveguide example.
The cross-section is a 2D rail profile (60E1, 60.21kg/m) with free boundary conditions on its 1D boundaries, material: elastic steel.
This eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers).
The FE mesh is built from gmsh with a .geo file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># This file is a tutorial for waveguicsx (*), whose inputs are
# the matrices K0, K1, K2, M and the excitation vector F.
# In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).
#  (*) waveguicsx is a python library for solving complex waveguide problems
#      Copyright (C) 2023-2024  Fabien Treyssede
#      waveguicsx is free software distributed under the GNU General Public License
#      (https://github.com/treyssede/waveguicsx)
# (**) FEniCSx is an open-source computing platform for solving partial differential equations
#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)

##################################
# 3D elastic waveguide example\
# The cross-section is a 2D rail profile (60E1, 60.21kg/m) with free boundary conditions on its 1D boundaries, material: elastic steel\
# The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\
# $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\
# This eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers).\
# The FE mesh is built from gmsh with a .geo file.

import dolfinx
import ufl
from mpi4py import MPI
from petsc4py import PETSc
from slepc4py import SLEPc
import numpy as np
import matplotlib.pyplot as plt
import pyvista

from waveguicsx.waveguide import Waveguide
#For proper use with a jupyter notebook, uncomment the following line:
#pyvista.set_jupyter_backend(&quot;none&quot;); pyvista.start_xvfb() #try also: &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...

##################################
# Input parameters
a = np.sqrt(76.70e-4)/2 #characteristic length (m) = halfwidth of a square of identical cross-section (rail cross-section : 76.70cm2)
le = a/8 #finite element characteristic length (m)
rho, cs, cl = 7850.0, 3207.7, 6001.0 #density (kg/m3), shear and longitudinal wave celerities (m/s)
kappas, kappal = 0*0.008, 0*0.003 #shear and longitudinal bulk wave attenuations (Np/wavelength)
omega, nev = 2*np.pi*np.linspace(100, 5000, 50), 20 #angular frequencies (rad/s) and number of eigenvalues (low-frequency regime)
#wavenumber, nev = 2*np.pi*np.linspace(1e3, 1e5, 100)/cs, 100 #angular frequencies (rad/s) and number of eigenvalues (high-frequency regime)
#reminder:
#E, nu, rho = 2.1e+11, 0.3, 7850
#cs = np.sqrt(E/rho/(2*(1+nu)))
#cl = np.sqrt(E/rho*(1-nu)/((1+nu)*(1-2*nu)))

##################################
# Re-scaling
L0 = a #characteristic length
T0 = a/cs #characteristic time
M0 = rho*a**3#characteristic mass
a, le = a/L0, le/L0
rho, cs, cl = rho/M0*L0**3, cs/L0*T0, cl/L0*T0
omega = omega*T0
#wavenumber = wavenumber*L0
cs, cl = cs/(1+1j*kappas/2/np.pi), cl/(1+1j*kappal/2/np.pi) #complex celerities

##################################
# Build mesh from Gmsh and import to dolfinx (six-node triangles with three dofs per node for the three components of displacement)

!gmsh rail60E1_60.21kg_m.geo -2 -order 2 -setnumber Mesh.MeshSizeFactor {le*L0*1000} -setnumber Mesh.ScalingFactor {1/(1000*L0)} #units in .geo are in mm
mesh, cell_tags, facet_tags = dolfinx.io.gmshio.read_from_msh(&quot;rail60E1_60.21kg_m.msh&quot;, MPI.COMM_WORLD, rank=0, gdim=2)

##################################
# Visualize FE mesh with pyvista
Vmesh = dolfinx.fem.FunctionSpace(mesh, ufl.FiniteElement(&quot;CG&quot;, &quot;triangle&quot;, 1)) #order 1 is properly handled with pyvista
plotter = pyvista.Plotter()
grid = pyvista.UnstructuredGrid(*dolfinx.plot.create_vtk_mesh(Vmesh))
grid.cell_data[&quot;Marker&quot;] = cell_tags.values
grid.set_active_scalars(&quot;Marker&quot;)
plotter.add_mesh(grid, show_edges=True, show_scalar_bar=False)
plotter.view_xy()
plotter.show()
# Finite element space
element = ufl.VectorElement(&quot;CG&quot;, &quot;triangle&quot;, 2, 3) #Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector
V = dolfinx.fem.FunctionSpace(mesh, element)

##################################
# Create Material properties (isotropic)
def isotropic_law(rho, cs, cl):
    E, nu = rho*cs**2*(3*cl**2-4*cs**2)/(cl**2-cs**2), 0.5*(cl**2-2*cs**2)/(cl**2-cs**2)
    C11 = C22 = C33 = E/(1+nu)/(1-2*nu)*(1-nu)
    C12 = C13 = C23 = E/(1+nu)/(1-2*nu)*nu
    C44 = C55 = C66 = E/(1+nu)/2
    return np.array([[C11,C12,C13,0,0,0], 
                     [C12,C22,C23,0,0,0], 
                     [C13,C23,C33,0,0,0], 
                     [0,0,0,C44,0,0], 
                     [0,0,0,0,C55,0], 
                     [0,0,0,0,0,C66]])
C = isotropic_law(rho, cs, cl)
C = dolfinx.fem.Constant(mesh, PETSc.ScalarType(C))

##################################
# Create free boundary conditions
bcs = []

##################################
# Define variational problem (SAFE method)
u = ufl.TrialFunction(V)
v = ufl.TestFunction(V)
Lxy = lambda u: ufl.as_vector([u[0].dx(0), u[1].dx(1), 0, u[0].dx(1)+u[1].dx(0), u[2].dx(0), u[2].dx(1)])
Lz  = lambda u: ufl.as_vector([0, 0, u[2], 0, u[0], u[1]])
k0 = ufl.inner(C*Lxy(u), Lxy(v)) * ufl.dx
k0_form = dolfinx.fem.form(k0)
k1 = ufl.inner(C*Lz(u), Lxy(v)) * ufl.dx
k1_form = dolfinx.fem.form(k1)
k2 = ufl.inner(C*Lz(u), Lz(v)) * ufl.dx
k2_form = dolfinx.fem.form(k2)
m = rho*ufl.inner(u, v) * ufl.dx
mass_form = dolfinx.fem.form(m)

##################################
# Build PETSc matrices
M = dolfinx.fem.petsc.assemble_matrix(mass_form, bcs=bcs, diagonal=0.0)
M.assemble()
K0 = dolfinx.fem.petsc.assemble_matrix(k0_form, bcs=bcs)
K0.assemble()
K1 = dolfinx.fem.petsc.assemble_matrix(k1_form, bcs=bcs, diagonal=0.0)
K1.assemble()
K2 = dolfinx.fem.petsc.assemble_matrix(k2_form, bcs=bcs, diagonal=0.0)
K2.assemble()

##################################
# Solve the eigenproblem with SLEPc (the parameter is omega, the eigenvalue is k)
wg = Waveguide(MPI.COMM_WORLD, M, K0, K1, K2)
wg.set_parameters(omega=omega)
#wg.set_parameters(wavenumber=wavenumber)
wg.evp.setTolerances(tol=1e-8, max_it=20)
wg.solve(nev=nev, target=0) #access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]

##################################
# Plot dispersion curves in the low-frequency regime (for comparison, see e.g. Zhang et al., Mechanical Systems and Signal Processing, 150, 1-22 (2021))
wg.set_plot_scaler(length=L0, time=T0, mass=M0)
sc = wg.plot()
sc.axes.set_xlim([0, 25])
sc.axes.set_ylim([0, 5000])
sc = wg.plot_phase_velocity()
sc.axes.set_xlim([0, 5000])
sc.axes.set_ylim([0, 6000])
sc = wg.plot_group_velocity(direction=+1)
sc.axes.set_xlim([0, 5000])
sc.axes.set_ylim([0, 6000])
plt.show()

###############################################################################
# Plot phase velocity dispersion curves in the high-frequency regime (for comparison, see e.g. Ge et al., Structural Health Monitoring, 21, 1287-1308 (2022))
if False:
    wg.set_plot_scaler(length=L0, time=T0, mass=M0)
    wg.plot_scaler[&#39;frequency&#39;] = wg.plot_scaler[&#39;frequency&#39;]/1000
    sc = wg.plot_phase_velocity()
    sc.axes.set_xlim([0, 1e2])
    sc.axes.set_ylim([0, 12000])
    sc.axes.set_xlabel(&#39;frequency (kHz)&#39;)
    sc.axes.set_ylabel(&#39;phase velocity (m/s)&#39;)
    #plt.savefig(&#39;rail_phase_velocity.png&#39;)
    plt.show()

##################################
# Mode shape visualization
ik, imode = 49, 9 #parameter index, mode index to visualize
print(f&quot;f={wg.omega[ik]/(2*np.pi*T0):1.1f}Hz, l={2*np.pi*L0/wg.eigenvalues[ik][imode].real:1.2f}m&quot;)
vec = wg.eigenvectors[ik].getColumnVector(imode)
grid_interp = pyvista.UnstructuredGrid(*dolfinx.plot.create_vtk_mesh(Vmesh))
grid = pyvista.UnstructuredGrid(*dolfinx.plot.create_vtk_mesh(V))
grid[&quot;u&quot;] = np.array(vec).real.reshape(int(np.array(vec).size/V.element.value_shape), int(V.element.value_shape)) #V.element.value_shape is equal to 3
grid_interp = grid_interp.interpolate(grid) #interpolation onto a finite element mesh of order 1 to plot both the FE mesh and the results with pyvista
plotter = pyvista.Plotter()
plotter.add_mesh(grid_interp.warp_by_vector(&quot;u&quot;, factor=0.1), show_scalar_bar=False, show_edges=True)
#plotter.show_axes()
plotter.view_xy()
plotter.screenshot(&#39;rail_mode_shape.png&#39;, transparent_background=True)
plotter.show()

</pre></div>
</div>
</section>
<section id="reflection-of-lamb-modes-by-the-free-edge-of-a-plate">
<h2>8. Reflection of Lamb modes by the free edge of a plate<a class="headerlink" href="#reflection-of-lamb-modes-by-the-free-edge-of-a-plate" title="Permalink to this heading"></a></h2>
<p>Scattering in 2D elastic waveguide example (reflection of Lamb modes by the free edge of a plate).
The cross-section is a 1D line with free boundary conditions on its boundaries.
The inhomogeneous part, including the free edge, is a 2D rectangle.
Material: elastic steel.
The problem is solved using FEM with transparent boundary condition (tbc) in the inlet cross-section.
The inlet eigenproblem is solved using SAFE as a function of frequency (eigenvalues are wavenumbers).
Results can be compared with Fig. 4 of paper: Karunasena et al., CMAME 125 (1995), 221-233 (see also
Gregory and Gladwell, J. of Elast. 13 (1983), 185-206).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are:</span>
<span class="c1"># - the matrices K, M, C and the internal excitation vector F</span>
<span class="c1"># - the matrices K0, K1, K2 and Ms for each transparent BC.</span>
<span class="c1"># In the tutorial, these matrices are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023-2024  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># Scattering in 2D elastic waveguide example (reflection of Lamb modes by the free edge of a plate)\</span>
<span class="c1"># The cross-section is a 1D line with free boundary conditions on its boundaries\</span>
<span class="c1"># The inhomogeneous part, including the free edge, is a 2D rectangle\</span>
<span class="c1"># material: elastic steel\</span>
<span class="c1"># The problem is solved using FEM with transparent boundary condition (tbc) in the inlet cross-section\</span>
<span class="c1"># The inlet eigenproblem is solved using SAFE as a function of frequency (eigenvalues are wavenumbers)\</span>
<span class="c1"># Results can be compared with Fig. 4 of paper: Karunasena et al., CMAME 125 (1995), 221-233 (see also\</span>
<span class="c1"># Gregory and Gladwell, J. of Elast. 13 (1983), 185-206).</span>

<span class="kn">import</span> <span class="nn">gmsh</span> <span class="c1">#full documentation entirely defined in the `gmsh.py&#39; module</span>
<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="kn">from</span> <span class="nn">waveguicsx.scattering</span> <span class="kn">import</span> <span class="n">Scattering</span>
<span class="c1">#For proper use with a jupyter notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;static&quot;); pyvista.start_xvfb() #try also: &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#plate thickness (m)</span>
<span class="n">L</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#plate length (m) for the inhomogeneous part</span>
<span class="n">le</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="mi">5</span> <span class="c1">#finite element characteristic length (m)</span>
<span class="n">E</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="mf">2.0e+11</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">7800</span> <span class="c1">#Young&#39;s modulus (Pa), Poisson ratio, density (kg/m3)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mf">0.008</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.003</span><span class="o">*</span><span class="mi">0</span> <span class="c1">#shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="n">rho</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">))),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)))</span> <span class="c1">#shear and longitudinal wave celerities</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.48</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="n">cs</span><span class="o">/</span><span class="n">h</span> <span class="c1">#angular frequencies (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1">#number of eigenvalues</span>
<span class="n">free_end</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#True: only one tbc (at one end), False: two tbcs (at both ends, to check that an incident mode is outgoing properly)</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">h</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">h</span><span class="o">**</span><span class="mi">3</span> <span class="c1">#characteristic mass</span>
<span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">le</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">L</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">le</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities</span>

<span class="c1">##################################</span>
<span class="c1"># Create FE mesh (2D)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">tbc0</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">tbc1</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">domain</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">tbc0</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#tag=0: 1st transparent boundary condition, &#39;inlet&#39;</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">tbc1</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#tag=1: 2nd transparent boundary condition, &#39;outlet&#39;</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">domain</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#tag=2: the whole FE domain (2D mesh)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setOrder</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#gmsh.model.mesh.recombine() #recombine into quadrilaterals</span>
<span class="n">mesh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">,</span> <span class="n">facet_tags</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gmshio</span><span class="o">.</span><span class="n">model_to_mesh</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gdim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">tbc_tags</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">free_end</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1">##################################</span>
<span class="c1"># Finite element space (2D)</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 2D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Visualize FE mesh with pyvista</span>
<span class="n">Vmesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">#cell of order 1 is properly handled with pyvista</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Vmesh</span><span class="p">))</span>
<span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">values</span>
<span class="n">grid</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Marker&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">grid_nodes</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span> <span class="c1">#add higher-order nodes</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid_nodes</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">render_points_as_spheres</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C33</span><span class="p">))</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Define the 2D variational formulation (FE problem inside the box)</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">mesh</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">L</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">L</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">k_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">dofs</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">dofs</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1">#global dof vector</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Determination of sign of outward normal of transparent boundaries (for check)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="n">facet_tags</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FacetNormal</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
<span class="n">ey</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="c1">#ey: unit vector along the waveguide axis</span>
<span class="n">tbc_normal</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tbc_tags</span><span class="p">:</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ey</span><span class="p">)</span> <span class="o">*</span> <span class="n">ds</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="c1">#integration of the y-component of normal along the boundary</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">normal</span><span class="p">))</span><span class="o">.</span><span class="n">real</span>
    <span class="n">tbc_normal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int8&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tbc_normal</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># For each transparent boundary condition:</span>
<span class="c1"># - extract the FE mesh (1D)</span>
<span class="c1"># - define the variational form (SAFE formulation)</span>
<span class="c1"># - assemble matrices</span>
<span class="c1"># - locate tbc dofs in the global matrix</span>
<span class="n">Ms</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">tbc_dofs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tbc_tags</span><span class="p">:</span>  
    <span class="c1">#Extract the 1D mesh</span>
    <span class="n">safe_mesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_submesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">facet_tags</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">values</span><span class="o">==</span><span class="n">tag</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#Define the variational form</span>
    <span class="n">safe_element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">safe_mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">safe_V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">safe_mesh</span><span class="p">,</span> <span class="n">safe_element</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">safe_mesh</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">safe_V</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">safe_V</span><span class="p">)</span>
    <span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span>
    <span class="n">Lz</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">k0_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">Ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">))</span>
    <span class="n">Ms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
    <span class="n">K0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k0_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">))</span>
    <span class="n">K0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
    <span class="n">K1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">))</span>
    <span class="n">K1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
    <span class="n">K2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">))</span>
    <span class="n">K2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
    <span class="c1">#Locate tbc dofs in the global matrix (trick using interpolate)</span>
    <span class="n">tbc_dofs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">safe_V</span><span class="p">))</span>
    <span class="n">tbc_dofs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">dofs</span><span class="p">)</span>
    <span class="n">tbc_dofs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbc_dofs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>    

<span class="c1">##################################</span>
<span class="c1"># Scattering initialization</span>
<span class="n">tbcs</span> <span class="o">=</span>  <span class="p">[(</span><span class="s1">&#39;waveguide0&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">tbc_dofs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">if</span> <span class="n">free_end</span> <span class="k">else</span> <span class="p">[(</span><span class="s1">&#39;waveguide0&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">tbc_dofs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="s1">&#39;waveguide1&#39;</span><span class="p">,</span> <span class="o">+</span><span class="n">tbc_dofs</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="c1">#-1 because tbc_normal[0]=-1</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">Scattering</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span><span class="p">,</span> <span class="n">tbcs</span><span class="p">)</span>
<span class="c1">#Solve waveguide problem of 1st tbc</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Transparent boundary condition 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">Ms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">compute_traveling_direction</span><span class="p">()</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">compute_poynting_normalization</span><span class="p">()</span>
<span class="c1">#Solve waveguide problem of 2nd tbc</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">free_end</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Transparent boundary condition 1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">Ms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">K0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">K1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">K2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">compute_traveling_direction</span><span class="p">()</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">compute_poynting_normalization</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Solving scattering problem</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">4.36</span><span class="p">))</span> <span class="c1">#4.36 is the S1 wavenumber value at angular frequency 5.13 (roughly)</span>
<span class="n">mode</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">track_mode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#track ingoing S1 mode over the whole frequency range</span>
<span class="n">ws</span><span class="o">.</span><span class="n">set_ingoing_mode</span><span class="p">(</span><span class="s1">&#39;waveguide0&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="c1">#set mode as a single ingoing mode, coeff is 1 (its power is also 1 thanks to poynting normalization)</span>
<span class="n">ws</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;KSP solver type: </span><span class="si">{</span><span class="n">ws</span><span class="o">.</span><span class="n">ksp</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ws</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">ws</span><span class="o">.</span><span class="n">plot_energy_balance</span><span class="p">()</span> <span class="c1">#checking tbc modal truncature</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Plot modal coefficients vs. angular frequency\</span>
<span class="c1"># Results can be compared with Fig. 4 of paper: Karunasena et al., CMAME 125 (1995), 221-233\</span>
<span class="c1"># (see also Gregory and Gladwell, J. of Elast. 13 (1983), 185-206).</span>

<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">compute_complex_power</span><span class="p">()</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;complex_power&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span> <span class="n">direction</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Reflected power&#39;</span><span class="p">)</span>
<span class="c1">#ws.waveguide0.plot_complex_power() #plot both real and imaginary part (signed)</span>
<span class="c1">#ws.waveguide0.plot_energy_velocity(c=(&#39;coefficient&#39;, np.abs)) #plot ve curves colored by |q|</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">free_end</span><span class="p">:</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">compute_complex_power</span><span class="p">()</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;complex_power&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span> <span class="n">direction</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Transmitted power&#39;</span><span class="p">)</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Example of plot for a single mode</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">4.36</span><span class="p">))</span> <span class="c1">#-4.36 is the opposite S1 wavenumber value at angular frequency 5.13 (roughly)</span>
<span class="n">mode2</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">track_mode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#track reflected S1 mode</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">plot_complex_power</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode2</span><span class="p">)</span>
<span class="n">sc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Example of plot for displacement field at a given angular frequency</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1">#angular frequency index</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="c1">#grid[&quot;ux&quot;] = np.array(vec).real[0::2] #x-component of displacement</span>
<span class="n">grid</span><span class="p">[</span><span class="s2">&quot;uy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#y-component of displacement</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Save matrices into file (for basic usage of waveguicsx, see README examples)</span>
<span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span><span class="o">.</span><span class="n">createBinary</span><span class="p">(</span><span class="s1">&#39;BasicScatteringExample.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">dofs</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Vec</span><span class="p">()</span><span class="o">.</span><span class="n">createSeq</span><span class="p">(</span><span class="n">tbc_dofs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<span class="n">dofs</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">tbc_dofs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">tbc_dofs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Ms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dofs</span><span class="p">]:</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">viewer</span><span class="o">=</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="reflection-and-transmission-of-pochhammer-chree-modes-inside-a-cylinder">
<h2>9. Reflection and transmission of Pochhammer-Chree modes inside a cylinder<a class="headerlink" href="#reflection-and-transmission-of-pochhammer-chree-modes-inside-a-cylinder" title="Permalink to this heading"></a></h2>
<p>Scattering in 3D elastic waveguide example.
Reflection of Pochhammer-Chree modes by the free edge of a cylinder or by notch.
The cross-section is a 2D disk with free boundary conditions on its boundaries.
The inhomogeneous part, including free edge or notch, is a 3D cylinder.
Material: elastic steel.
The problem is solved using FEM with transparent boundary condition in the inlet and outlet cross-sections.
The tbc eigenproblem is solved using SAFE as a function of frequency (eigenvalues are wavenumbers)Results can be compared with the following papers, for free edge and notch respectively:</p>
<ul class="simple">
<li><p>Gregory and Gladwell, Q. J. Mech. Appl. Math.  42 (1989), 327–337</p></li>
<li><p>Benmeddour et al., IJSS 48 (2011), 764-774.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are:</span>
<span class="c1"># - the matrices K, M, C and the internal excitation vector F</span>
<span class="c1"># - the matrices K0, K1, K2 and Ms for each transparent BC.</span>
<span class="c1"># In the tutorial, these matrices are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023-2024  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># Scattering in 3D elastic waveguide example</span>
<span class="c1"># Reflection of Pochhammer-Chree modes by the free edge of a cylinder or by notch\</span>
<span class="c1"># The cross-section is a 2D disk with free boundary conditions on its boundaries\</span>
<span class="c1"># The inhomogeneous part, including free edge or notch, is a 3D cylinder\</span>
<span class="c1"># material: elastic steel\</span>
<span class="c1"># The problem is solved using FEM with transparent boundary condition in the inlet and outlet cross-sections\</span>
<span class="c1"># The tbc eigenproblem is solved using SAFE as a function of frequency (eigenvalues are wavenumbers)\</span>
<span class="c1"># Results can be compared with the following papers, for free edge and notch respectively:</span>
<span class="c1"># - Gregory and Gladwell, Q. J. Mech. Appl. Math.  42 (1989), 327–337</span>
<span class="c1"># - Benmeddour et al., IJSS 48 (2011), 764-774.</span>

<span class="kn">import</span> <span class="nn">gmsh</span> <span class="c1">#full documentation entirely defined in the `gmsh.py&#39; module</span>
<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="kn">from</span> <span class="nn">waveguicsx.scattering</span> <span class="kn">import</span> <span class="n">Scattering</span>
<span class="c1">#For proper use with a jupyter notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;static&quot;); pyvista.start_xvfb() #try also: &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#cylinder radius (m)</span>
<span class="n">L</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span> <span class="c1">#cylinder length (m) for the inhomogeneous part</span>
<span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="mi">2</span> <span class="c1">#finite element characteristic length (m)</span>
<span class="n">E</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="mf">2.0e+11</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">7800</span> <span class="c1">#Young&#39;s modulus (Pa), Poisson ratio, density (kg/m3)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mf">0.008</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.003</span><span class="o">*</span><span class="mi">0</span> <span class="c1">#shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="n">rho</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">))),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)))</span>
<span class="c1">#omega = np.linspace(1.8, 2.4, num=50)*cl/a #angular frequencies (rad/s), for comparison with Gregory and Gladwell</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="o">*</span><span class="n">cl</span><span class="o">/</span><span class="n">a</span> <span class="c1">#for comparison with Benmeddour et al.</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">40</span> <span class="c1">#number of eigenvalues</span>
<span class="n">free_end</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#True: only one tbc (at one end), False: two tbcs (at both ends, note: check that an incident mode is outgoing properly)</span>
<span class="n">notch_depth</span><span class="p">,</span> <span class="n">notch_thickness</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">a</span> <span class="c1">#case without notch: set notch_depth to 0</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span> <span class="c1">#characteristic mass</span>
<span class="n">a</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">L</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">le</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>

<span class="c1">##################################</span>
<span class="c1"># Create FE mesh (2D)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCylinder</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">if</span> <span class="n">notch_depth</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#notch case</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addBox</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">L</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">notch_depth</span><span class="p">,</span> <span class="n">notch_thickness</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">cut</span><span class="p">([(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">volumes</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getEntities</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="n">volumes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">volumes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#volume tag: 0</span>
<span class="n">surfaces</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getEntities</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">surfaces</span><span class="p">:</span>
    <span class="n">center_of_mass</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getCenterOfMass</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#useful to identify surface numbers of tbcs</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">center_of_mass</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#inlet tbc tag: 0</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">center_of_mass</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">L</span><span class="p">):</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#outlet tbc tag: 1</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setOrder</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mesh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">,</span> <span class="n">facet_tags</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gmshio</span><span class="o">.</span><span class="n">model_to_mesh</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gdim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">tbc_tags</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">free_end</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1">##################################</span>
<span class="c1"># Finite element space (3D)</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;tetrahedron&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, tetrahedron, quadratic, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Visualize FE mesh with pyvista</span>
<span class="n">Vmesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;tetrahedron&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">#cell of order 1 is properly handled with pyvista</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Vmesh</span><span class="p">))</span>
<span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">values</span>
<span class="n">grid</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Marker&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">grid_nodes</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span> <span class="c1">#add higher-order nodes</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid_nodes</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">render_points_as_spheres</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">]])</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Define the 2D variational formulation</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">mesh</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">L</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                            <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">L</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">k_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">dofs</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">dofs</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1">#global dof vector</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Determination of sign of outward normal of transparent boundaries (for check)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="n">facet_tags</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FacetNormal</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
<span class="n">ez</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="c1">#ez: unit vector along the waveguide axis</span>
<span class="n">tbc_normal</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tbc_tags</span><span class="p">:</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ez</span><span class="p">)</span> <span class="o">*</span> <span class="n">ds</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="c1">#integration of the z-component of normal along the boundary</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">normal</span><span class="p">))</span><span class="o">.</span><span class="n">real</span>
    <span class="n">tbc_normal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int8&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tbc_normal</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># For each transparent boundary condition:</span>
<span class="c1"># - extract the FE mesh (2D)</span>
<span class="c1"># - define the variational form (SAFE formulation)</span>
<span class="c1"># - assemble matrices</span>
<span class="c1"># - locate tbc dofs in the global matrix</span>
<span class="n">Ms</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">tbc_dofs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tbc_tags</span><span class="p">:</span>  
    <span class="c1">#Extract the 2D mesh</span>
    <span class="n">safe_mesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_submesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">facet_tags</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">values</span><span class="o">==</span><span class="n">tag</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#Define the variational form</span>
    <span class="n">safe_element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">safe_mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">safe_V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">safe_mesh</span><span class="p">,</span> <span class="n">safe_element</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">safe_mesh</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">safe_V</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">safe_V</span><span class="p">)</span>
    <span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">k0_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">Ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">))</span>
    <span class="n">Ms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
    <span class="n">K0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k0_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">))</span>
    <span class="n">K0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
    <span class="n">K1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">))</span>
    <span class="n">K1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
    <span class="n">K2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">))</span>
    <span class="n">K2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
    <span class="c1">#Locate tbc dofs in the global matrix (trick using interpolate)</span>
    <span class="n">tbc_dofs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">safe_V</span><span class="p">))</span>
    <span class="n">tbc_dofs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">dofs</span><span class="p">)</span>
    <span class="n">tbc_dofs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbc_dofs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>    

<span class="c1">##################################</span>
<span class="c1"># Scattering initialization</span>
<span class="n">tbcs</span> <span class="o">=</span>  <span class="p">[(</span><span class="s1">&#39;waveguide0&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">tbc_dofs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">if</span> <span class="n">free_end</span> <span class="k">else</span> <span class="p">[(</span><span class="s1">&#39;waveguide0&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">tbc_dofs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="s1">&#39;waveguide1&#39;</span><span class="p">,</span> <span class="o">+</span><span class="n">tbc_dofs</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="c1">#-1 because tbc_normal[0]=-1</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">Scattering</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="n">M</span><span class="p">,</span> <span class="n">tbcs</span><span class="p">)</span>
<span class="c1">#Solve waveguide problem of 1st tbc</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Transparent boundary condition 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">Ms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">compute_traveling_direction</span><span class="p">()</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">compute_poynting_normalization</span><span class="p">()</span>
<span class="c1">#Solve waveguide problem of 2nd tbc</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">free_end</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Transparent boundary condition 1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">Ms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">K0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">K1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">K2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">compute_traveling_direction</span><span class="p">()</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">compute_poynting_normalization</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Solving scattering problem</span>
<span class="c1"># index = np.argmin(np.abs(ws.waveguide0.eigenvalues[0]-2.59)) #2.59 is the L(0,1) wavenumber value at angular frequency 3.12 (roughly), for comparison with Gregory and Gladwell</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.11</span><span class="p">))</span> <span class="c1">#0.11 is the L(0,1) wavenumber value at angular frequency 0.17 (roughly), for comparison with Benmeddour et al.</span>
<span class="n">mode</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">track_mode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#track mode over the whole frequency range</span>
<span class="n">ws</span><span class="o">.</span><span class="n">set_ingoing_mode</span><span class="p">(</span><span class="s1">&#39;waveguide0&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="c1">#set mode as a single ingoing mode, coeff is 1 (its power is also 1 thansk to poynting normalization)</span>
<span class="n">ws</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>
<span class="n">ws</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">ws</span><span class="o">.</span><span class="n">plot_energy_balance</span><span class="p">()</span> <span class="c1">#checking tbc modal truncature</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">#ws.ksp.view()</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Plot modal coefficients w.r.t angular frequency\</span>
<span class="c1"># Results can be compared with paper: Gregory and Gladwell, Q. J. Mech. Appl. Math.  42 (1989), 327–337</span>
<span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">compute_complex_power</span><span class="p">()</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;complex_power&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span> <span class="n">direction</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Reflected power&#39;</span><span class="p">)</span>
<span class="c1">#ws.waveguide0.plot_complex_power() #plot both real and imaginary part (signed)</span>
<span class="c1">#ws.waveguide0.plot_energy_velocity(c=(&#39;coefficient&#39;, np.abs)) #plot ve curves colored by |q|</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">free_end</span><span class="p">:</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">compute_complex_power</span><span class="p">()</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">waveguide1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;complex_power&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span> <span class="n">direction</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Transmitted power&#39;</span><span class="p">)</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Example of plot for a single mode</span>
<span class="c1"># index = np.argmin(np.abs(ws.waveguide0.eigenvalues[0]+2.59)) #-2.59 is the opposite L(0,1) wavenumber value at angular frequency 3.12 (roughly)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.11</span><span class="p">))</span> <span class="c1">#-0.11 is the opposite L(0,1) wavenumber value at angular frequency 0.17 (roughly)</span>
<span class="n">mode2</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">track_mode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#track mode (0, 0))</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">waveguide0</span><span class="o">.</span><span class="n">plot_complex_power</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode2</span><span class="p">)</span>
<span class="n">sc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Example of plot for displacement field at a given angular frequency</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#angular frequency index</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="c1">#grid[&quot;ux&quot;] = np.array(vec).real[0::3] #x-component of displacement</span>
<span class="c1">#grid[&quot;uy&quot;] = np.array(vec).real[1::3] #y-component of displacement</span>
<span class="n">grid</span><span class="p">[</span><span class="s2">&quot;uz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span> <span class="c1">#z-component of displacement</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="s2">&quot;&quot;</span>

</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="waveguicsx.html" class="btn btn-neutral float-left" title="waveguicsx.waveguide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-2024, Fabien Treyssede.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>